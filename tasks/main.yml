---
- name: NGINX | Adding NGINX signing key
  apt_key: url=http://nginx.org/keys/nginx_signing.key state=present

- name: NGINX | Adding sources.list deb url for NGINX
  lineinfile: dest=/etc/apt/sources.list line="deb http://nginx.org/packages/mainline/ubuntu/ trusty nginx"

- name: NGINX Plus | Adding sources.list deb-src url for NGINX
  lineinfile: dest=/etc/apt/sources.list line="deb-src http://nginx.org/packages/mainline/ubuntu/ trusty nginx"

- name: NGINX | Updating apt cache
  apt:
    update_cache: yes

- name: NGINX | Installing NGINX
  apt:
    pkg: nginx
    state: latest

- name: NGINX | Generate dhparam file
  # -dsaparm => https://goo.gl/OkbDqi for faster generation
  command: openssl dhparam -dsaparam -out /etc/ssl/dhparam.pem 4096 creates=/etc/ssl/dhparam.pem

- name: NGINX | Ensure ssl dir exists
  become: true
  file: path={{ nginx_root }}/ssl/{{ nginx_ssl_cn }} state=directory

- name: NGINX | Create self-signed SSL cert
  become: true
  shell: >
    openssl req -x509 -nodes -subj '/
    /C={{ nginx_ssl_c }}
    /ST={{ nginx_ssl_st }}
    /L={{ nginx_ssl_l }}
    /O={{ nginx_ssl_o }}
    /CN={{ nginx_ssl_cn }}
    ' -days 365 -newkey rsa:2048 
    -out /etc/nginx/ssl/{{ nginx_ssl_cn }}/cert.pem
    -keyout /etc/nginx/ssl/{{ nginx_ssl_cn }}/privkey.key 
    creates=/etc/nginx/ssl/{{ nginx_ssl_cn }}/cert.pem
  notify: restart nginx

- name: NGINX | Ensures {{nginx_docroot}}/ dir exists
  file: path={{nginx_docroot}} state=directory

- name: NGINX | Add SSL config
  template: src=ssl.tpl dest={{ nginx_root }}/ssl.conf
  notify: restart nginx

- name: NGINX | Set secure nginx config
  template: src=nginx.conf.j2 dest={{ nginx_root}}/nginx.conf
  notify: restart nginx

- name: NGINX | Change default nginx site
  template: src=default_site.conf.j2 dest={{ nginx_root }}/conf.d/default.conf
  notify: restart nginx

- name: NGINX | Starting NGINX
  service:
    name: nginx
    state: started
